<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Explore a Kubernetes deployment on Jetstream with Kubespray 2/3 | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Explore a Kubernetes deployment on Jetstream with Kubespray 2/3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the second part of the tutorial on deploying Kubernetes with kubespray and JupyterHub on Jetstream." />
<meta property="og:description" content="This is the second part of the tutorial on deploying Kubernetes with kubespray and JupyterHub on Jetstream." />
<link rel="canonical" href="https://zonca.dev/2018/09/kubernetes-jetstream-kubespray-explore.html" />
<meta property="og:url" content="https://zonca.dev/2018/09/kubernetes-jetstream-kubespray-explore.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-23T23:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Explore a Kubernetes deployment on Jetstream with Kubespray 2/3","url":"https://zonca.dev/2018/09/kubernetes-jetstream-kubespray-explore.html","dateModified":"2018-09-23T23:00:00-05:00","datePublished":"2018-09-23T23:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2018/09/kubernetes-jetstream-kubespray-explore.html"},"description":"This is the second part of the tutorial on deploying Kubernetes with kubespray and JupyterHub on Jetstream.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Explore a Kubernetes deployment on Jetstream with Kubespray 2/3</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2018-09-23T23:00:00-05:00" itemprop="datePublished">
        Sep 23, 2018
      </time>
    </p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#kubernetes">kubernetes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#kubespray">kubespray</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream">jetstream</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2018-09-23-jetstream_kubernetes_kubespray_explore.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This is the second part of the tutorial on deploying Kubernetes with <code class="language-plaintext highlighter-rouge">kubespray</code> and JupyterHub
on Jetstream.</p>

<p>In the <a href="https://zonca.github.io/2018/09/kubernetes-jetstream-kubespray.html">first part, we installed Kubernetes on Jetstream with <code class="language-plaintext highlighter-rouge">kubespray</code></a>.</p>

<p>It is optional, its main purpose is to familiarize with the Kubernetes deployment on Jetstream
and how the different components play together before installing JupyterHub.
If you are already familiar with Kubernetes you can skip to <a href="https://zonca.github.io/2018/09/kubernetes-jetstream-kubespray-jupyterhub.html">next part where we will be installing
Jupyterhub using the zerotojupyterhub helm recipe</a>.</p>

<p>All the files for the examples below are available on Github,
first SSH to the master node (or do this locally if you setup <code class="language-plaintext highlighter-rouge">kubectl</code> locally):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream
cd jupyterhub-deploy-kubernetes-jetstream
</code></pre></div></div>

<h2 id="test-persistent-storage-with-cinder">Test persistent storage with cinder</h2>

<p>The most important feature that brought me to choose <code class="language-plaintext highlighter-rouge">kubespray</code> as method for installing Kubernetes
is that it automatically sets up persistent storage exploiting Jetstream Volumes.
The Jetstream team already does a great job in providing a persistent storage solution with adequate
redundancy via the Cinder project, part of OpenStack.</p>

<p><code class="language-plaintext highlighter-rouge">kubespray</code> sets up a Kubernetes provisioner so that when a container requests persistent storage,
it talks to the Openstack API and have a dedicated volume (the same type you can create with the
Jetstream Horizon Web interfaces) automatically created and exposed to Kubernetes.</p>

<p>This is achieved through a storageclass:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get storageclass
NAME                 PROVISIONER            AGE
standard (default)   kubernetes.io/cinder   1h
</code></pre></div></div>

<p>See the file <code class="language-plaintext highlighter-rouge">alpine-persistent-volume.yaml</code> in the repository on how we can request a Cinder volume
to be created and attached to a pod.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f alpine-persistent-volume.yaml
</code></pre></div></div>

<p>We can test it by getting a terminal inside the container (<code class="language-plaintext highlighter-rouge">alpine</code> has no <code class="language-plaintext highlighter-rouge">bash</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl exec -it alpine -- /bin/sh
</code></pre></div></div>

<p>look into <code class="language-plaintext highlighter-rouge">df -h</code>, check that there is a 5GB mounted file system which is persistent.</p>

<p>Also, back to the machine with <code class="language-plaintext highlighter-rouge">openstack</code> access, see how an Openstack volume was dynamically created and attached to the running instance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack volume list
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack volume list
+--------------------------------------+-------------------------------------------------------------+--------+------+--------------------------------------------------+
| ID                                   | Name                                                        | Status | Size | Attached to                                      |
+--------------------------------------+-------------------------------------------------------------+--------+------+--------------------------------------------------+
| 508f1ee7-9654-4c84-b1fc-76dd8751cd6e | kubernetes-dynamic-pvc-e83ec4d6-bb9f-11e8-8344-fa163eb22e63 | in-use |    5 | Attached to kubespray-k8s-node-nf-1 on /dev/sdb  |
+--------------------------------------+-------------------------------------------------------------+--------+------+--------------------------------------------------+
</code></pre></div></div>

<h2 id="test-replicasets-services-and-ingress">Test ReplicaSets, Services and Ingress</h2>

<p>In this section we will explore how to build redundancy and scale in a service with a
simple example included in the book <a href="https://github.com/luksa/kubernetes-in-action/tree/master/Chapter02/kubia">Kubernetes in Action</a>,
which by the way I highly recommend to get started with Kubernetes.</p>

<p>First let’s deploy a service in our Kubernetes cluster,
this service just answers to HTTP requests on port 8080 with the message “You’ve hit kubia-manual”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd kubia_test_ingress
kubectl create -f kubia-manual.yaml
</code></pre></div></div>

<p>We can test it by checking at which IP Kubernetes created the pod:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -o wide
</code></pre></div></div>

<p>and assign it to the <code class="language-plaintext highlighter-rouge">KUBIA_MANUAL_IP</code> variable, then on one of the nodes:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ curl $KUBIA_MANUAL_IP:8080
You've hit kubia-manual
</code></pre></div></div>

<p>Finally close it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete -f kubia-manual.yaml
</code></pre></div></div>

<h3 id="load-balancing-with-replicasets-and-services">Load balancing with ReplicaSets and Services</h3>

<p>Now we want to scale this service up and provide a set of 3 pods instead of just 1:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f kubia-replicaset.yaml
</code></pre></div></div>

<p>Now we could access those services on 3 different IP addresses, but we would like to have
a single entry point and automatic load balancing across those instances, so we create
a Kubernetes “Service” resource:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f kubia-service.yaml
</code></pre></div></div>

<p>And test it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ kubectl get service
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.233.0.1      &lt;none&gt;        443/TCP   22h
kubia        ClusterIP   10.233.28.205   &lt;none&gt;        80/TCP    45m
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl $KUBIA_SERVICE_IP
</code></pre></div></div>

<p>This is on port 80 so we don’t need <code class="language-plaintext highlighter-rouge">:8080</code> in the URL.
Run many times and check different kubia services answer.</p>

<h3 id="publish-service-externally-with-ingress">Publish service externally with ingress</h3>

<p>Try to open browser and access the hostname of your master node at:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://js-XXX-YYY.jetstream-cloud.org
</code></pre></div></div>

<p>Where XXX-YYY are the last 2 groups of digits of the floating IP of the master instance,
i.e. AAA.BBB.XXX.YYY, each of them could also be 1 or 2 digits instead of 3.</p>

<p>The connection should respond with 404.</p>

<p>At this point, edit the <code class="language-plaintext highlighter-rouge">kubia-ingress.yaml</code> file and replace the <code class="language-plaintext highlighter-rouge">host</code> value with the master node domain name you just derived.</p>

<p>Now:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f kubia-ingress.yaml
kubectl get ingress
</code></pre></div></div>

<p>Try again in the browser. You should now see something like:</p>

<p>“You’ve hit kubia-jqwwp”</p>

<p>Force reload the browser page a few times and you will see you are hitting a different kubia service.</p>

<p>Finally,</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl delete -f kubia-ingress.yaml
</code></pre></div></div>

  </div><a class="u-url" href="/2018/09/kubernetes-jetstream-kubespray-explore.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

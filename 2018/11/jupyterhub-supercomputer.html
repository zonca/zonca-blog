<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I described how to deploy JupyterHub with each user session running on a different node of a Supercomputer in my paper for PEARC18, however things are moving fast in the space and I am employing a different strategy this year, in particular relying on the littlest JupyterHub project for the initial deployment." />
<meta property="og:description" content="I described how to deploy JupyterHub with each user session running on a different node of a Supercomputer in my paper for PEARC18, however things are moving fast in the space and I am employing a different strategy this year, in particular relying on the littlest JupyterHub project for the initial deployment." />
<link rel="canonical" href="https://zonca.dev/2018/11/jupyterhub-supercomputer.html" />
<meta property="og:url" content="https://zonca.dev/2018/11/jupyterhub-supercomputer.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-07T11:00:00-06:00" />
<script type="application/ld+json">
{"headline":"Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition","url":"https://zonca.dev/2018/11/jupyterhub-supercomputer.html","dateModified":"2018-11-07T11:00:00-06:00","datePublished":"2018-11-07T11:00:00-06:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2018/11/jupyterhub-supercomputer.html"},"description":"I described how to deploy JupyterHub with each user session running on a different node of a Supercomputer in my paper for PEARC18, however things are moving fast in the space and I am employing a different strategy this year, in particular relying on the littlest JupyterHub project for the initial deployment.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2018-11-07T11:00:00-06:00" itemprop="datePublished">
        Nov 7, 2018
      </time>
    </p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#jupyterhub">jupyterhub</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#comet">comet</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#xsede">xsede</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2018-01-01-deploy_jupyterhub_supercomputer_2018.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I described how to deploy JupyterHub with each user session running on a different
node of a Supercomputer in <a href="https://arxiv.org/abs/1805.04781">my paper for PEARC18</a>,
however things are moving fast in the space and I am employing a different strategy
this year, in particular relying on <a href="https://the-littlest-jupyterhub.readthedocs.io">the littlest JupyterHub project</a>
for the initial deployment.</p>

<h2 id="initial-deployment-of-jupyterhub">Initial deployment of JupyterHub</h2>

<p><a href="https://the-littlest-jupyterhub.readthedocs.io">The littlest JupyterHub project</a> has great documentation
on how to deploy JupyterHub working on a single server on a wide array of providers.</p>

<p>In my case I logged in to the <a href="https://dashboard.cloud.sdsc.edu/">dashboard</a> of <a href="http://www.sdsc.edu/services/ci/cloud.html">SDSC Cloud</a>, a OpenStack
deployment at the San Diego Supercomputer Center, and requested an instance with 16 GB of RAM and 6 vCPUs with Ubuntu 18.04. Make sure you attach a floating public IP to the instance and open up ports 22 for SSH and 80,443 for HTTP/HTTPS.</p>

<p>Then I followed the <a href="https://the-littlest-jupyterhub.readthedocs.io/en/latest/install/custom-server.html">installation tutorial for custom servers</a>, just make sure that you first create in the virtual machine the admin user you specify in the installation script, also
make sure to use the same username of your Github account, as we will later setup Github Authentication.</p>

<p>You can connect to the instance and check JupyterHub is working and you can login with your user and access the admin panel,
for SDSC Cloud the address is <code class="language-plaintext highlighter-rouge">http://xxx-xxx-xxx-xxx.compute.cloud.sdsc.edu</code>, filled in with the instance floating IP address.</p>

<h3 id="setup-https">Setup HTTPS</h3>

<p>Follow the Littlest JupyterHub documentation on how to get a SSL certificate through Letsencrypt automatically, after this you should be able to access JupyterHub from <code class="language-plaintext highlighter-rouge">https://xxx-xxx-xxx-xxx.compute.cloud.sdsc.edu</code> or a custom domain you pointed there.</p>

<h2 id="authentication-with-github">Authentication with Github</h2>

<p>Follow the Littlest JupyterHub documentation, just make sure to set the <code class="language-plaintext highlighter-rouge">http</code> address and not the <code class="language-plaintext highlighter-rouge">https</code> address.</p>

<h2 id="interface-with-comet-via-batchspawner">Interface with Comet via batchspawner</h2>

<p>We want all users to run on Comet as a single “Gateway” user, as JupyterHub executes as the <code class="language-plaintext highlighter-rouge">root</code> user on the server, we want to create a SSH key for the <code class="language-plaintext highlighter-rouge">root</code> user and copy the public key to the home folder of the gateway user on Comet so that we can SSH without a password.</p>

<p>Instead, if you would like each user to utilize their own XSEDE account, you need them to authenticate via XSEDE and get a certificate from the XSEDE API that can be used to login to Comet on behalf of the user, see <a href="https://github.com/jupyterhub/jupyterhub-deploy-hpc/tree/master/batchspawner-xsedeoauth-sshtunnel-sdsccomet">an example deployment of this</a>.</p>

<p>First install <code class="language-plaintext highlighter-rouge">batchspawner</code> with <code class="language-plaintext highlighter-rouge">pip</code> in the Python environment of the hub, this is different than the Python environment of the user, you can have access to it logging in with the <code class="language-plaintext highlighter-rouge">root</code> user and running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export PATH=/opt/tljh/hub/bin:${PATH}
</code></pre></div></div>

<p>Set the configuration file, see <a href="https://gist.github.com/zonca/55f7949983e56088186e99db53548ded"><code class="language-plaintext highlighter-rouge">spawner.py</code> on this Gist</a> and copy it into the <code class="language-plaintext highlighter-rouge">/opt/tljh/config/jupyterhub_config.d</code> folder, then add the private SSH key of the tunnelbot user, which is a user on the Virtual Machine with no shell (set <code class="language-plaintext highlighter-rouge">/bin/false</code> in <code class="language-plaintext highlighter-rouge">/etc/passwd</code>) but that can setup a SSH tunnel from Comet back to the Hub.</p>

<p>Also customize all paths and usernames in the file.</p>

<p>Reload the Jupyterhub configuration with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tljh-config reload
</code></pre></div></div>

<p>You can then check the Hub logs with <code class="language-plaintext highlighter-rouge">sudo journalctl -r -u jupyterhub</code></p>

<p>The most complicated part is making sure that the environment variables defined by JupyterHub, the most important is the token which allows the singleuser server to authenticate itself with the Hub, are correctly propagated through SSH. See in <code class="language-plaintext highlighter-rouge">spawner.py</code> how I explicitely pass the variables over SSH.</p>

<p>Also, as all workshop participants access Comet with the same user account, I automatically create a folder with their Github username and checkout the Notebooks for the workshop in that folder. Then start JupyterLab in that folder, so that the users do not interfere, we are not worrying about security here, with the current setup a user can open a terminal inside JupyterLab and access the folder of another person.</p>

<h2 id="how-to-setup-the-tunnelbot-user">How to setup the tunnelbot user</h2>

<ul>
  <li>On the JupyterHub virtual machine, create a user named <code class="language-plaintext highlighter-rouge">tunnelbot</code></li>
  <li><code class="language-plaintext highlighter-rouge">sudo su tunnelbot</code> to act as that user, then create a key with <code class="language-plaintext highlighter-rouge">ssh-keygen</code></li>
  <li>enter the <code class="language-plaintext highlighter-rouge">.ssh</code> folder and <code class="language-plaintext highlighter-rouge">cp id_rsa.pub authorized_keys</code> so that the ssh key can be used from Comet to ssh passwordless to the server</li>
  <li>now get the <strong>private key</strong> from <code class="language-plaintext highlighter-rouge">/home/tunnelbot/.ssh/id_rsa</code> and paste it into <code class="language-plaintext highlighter-rouge">spawner.py</code></li>
  <li>now make sure you set the shell of <code class="language-plaintext highlighter-rouge">tunnelbot</code> to <code class="language-plaintext highlighter-rouge">/bin/false</code> in <code class="language-plaintext highlighter-rouge">/etc/passwd/</code></li>
  <li>for increased security, please also follow the steps in <a href="https://askubuntu.com/questions/48129/how-to-create-a-restricted-ssh-user-for-port-forwarding">this stackoverflow answer</a></li>
</ul>

<h2 id="acknowledgments">Acknowledgments</h2>

<p>Thanks to the Jupyter and JupyterHub teams for releasing great software with outstanding documentation, in particular Yuvi Panda for the simplicity and elegance in the design of the Littlest JupyterHub deployment.</p>

  </div><a class="u-url" href="/2018/11/jupyterhub-supercomputer.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

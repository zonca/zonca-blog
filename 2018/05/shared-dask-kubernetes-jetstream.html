<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Launch a shared dask cluster in Kubernetes alongside JupyterHub on Jetstream | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Launch a shared dask cluster in Kubernetes alongside JupyterHub on Jetstream" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Let’s assume we have already a Kubernetes deployment and have installed JupyterHub, see for example my previous tutorial on Jetstream. Now that users can login and access a Jupyter Notebook, we would also like to provide them more computing power for their interactive data exploration. The easiest way is through dask, we can launch a scheduler and any number of workers as containers inside Kubernetes so that users can leverage the computing power of many Jetstream instances at once." />
<meta property="og:description" content="Let’s assume we have already a Kubernetes deployment and have installed JupyterHub, see for example my previous tutorial on Jetstream. Now that users can login and access a Jupyter Notebook, we would also like to provide them more computing power for their interactive data exploration. The easiest way is through dask, we can launch a scheduler and any number of workers as containers inside Kubernetes so that users can leverage the computing power of many Jetstream instances at once." />
<link rel="canonical" href="https://zonca.dev/2018/05/shared-dask-kubernetes-jetstream.html" />
<meta property="og:url" content="https://zonca.dev/2018/05/shared-dask-kubernetes-jetstream.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-04T18:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Launch a shared dask cluster in Kubernetes alongside JupyterHub on Jetstream","url":"https://zonca.dev/2018/05/shared-dask-kubernetes-jetstream.html","dateModified":"2018-05-04T18:00:00-05:00","datePublished":"2018-05-04T18:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2018/05/shared-dask-kubernetes-jetstream.html"},"description":"Let’s assume we have already a Kubernetes deployment and have installed JupyterHub, see for example my previous tutorial on Jetstream. Now that users can login and access a Jupyter Notebook, we would also like to provide them more computing power for their interactive data exploration. The easiest way is through dask, we can launch a scheduler and any number of workers as containers inside Kubernetes so that users can leverage the computing power of many Jetstream instances at once.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Launch a shared dask cluster in Kubernetes alongside JupyterHub on Jetstream</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2018-05-04T18:00:00-05:00" itemprop="datePublished">
        May 4, 2018
      </time>
    </p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#jupyter">jupyter</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream">jetstream</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#dask">dask</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2018-05-04-shared-dask-kubernetes-jetstream.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Let’s assume we have already a Kubernetes deployment and have installed JupyterHub, see for example my <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">previous tutorial on Jetstream</a>.
Now that users can login and access a Jupyter Notebook, we would also like to provide them more computing power for their interactive data exploration. The easiest way is through <a href="https://dask.pydata.org"><code class="language-plaintext highlighter-rouge">dask</code></a>, we can launch a scheduler and any number of workers as containers inside Kubernetes so that users can leverage the computing power of many Jetstream instances at once.</p>

<p>There are 2 main strategies, we can give each user their own dask cluster with exclusive access and this would be more performant but cause quick spike of usage of the Kubernetes cluster, or just launch a shared cluster and give all users access to that.</p>

<p>In this tutorial we cover the second scenario, we’ll cover the first scenario in a following tutorial.</p>

<p>We will deploy first Jupyterhub through the Zero-to-JupyterHub guide, then launch via Helm a fixed size dask clusters and show how users can connect, submit distributed Python jobs and monitor their execution on the dashboard.</p>

<p>The configuration files mentioned in the tutorial are available in the Github repository <a href="https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream">zonca/jupyterhub-deploy-kubernetes-jetstream</a>.</p>

<h2 id="deploy-jupyterhub">Deploy JupyterHub</h2>

<p>First we start from Jupyterhub on Jetstream with Kubernetes at <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html</a></p>

<p>Optionally, for testing purposes, we can simplify the deployment by skipping permanent storage, if this is an option, see the relevant section below.</p>

<p>We want to install Jupyterhub in the <code class="language-plaintext highlighter-rouge">pangeo</code> namespace with the name <code class="language-plaintext highlighter-rouge">jupyter</code>, replace the <code class="language-plaintext highlighter-rouge">helm install</code> line in the tutorial with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo helm install --name jupyter jupyterhub/jupyterhub -f config_jupyterhub_pangeo_helm.yaml --namespace pangeo
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">pangeo</code> configuration file is using a different single user image which has the right version of <code class="language-plaintext highlighter-rouge">dask</code> for this tutorial.</p>

<h2 id="optional-simplify-deployment-using-ephemeral-storage">(Optional) Simplify deployment using ephemeral storage</h2>

<p>Instead of installing and configuring rook, we can temporarily disable permanent storage to make the setup quicker and easier to maintain.</p>

<p>In the JupyterHub configuration <code class="language-plaintext highlighter-rouge">yaml</code> set:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hub:
   db:
     type: sqlite-memory

singleuser:
   storage:
      type: none
</code></pre></div></div>

<p>Now every time a user container is killed and restarted, all data are gone, this is good enough for testing purposes.</p>

<h2 id="configure-github-authentication">Configure Github authentication</h2>

<p>Follow the instructions on the Zero-to-Jupyterhub documentation, at the end you should have in the YAML:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth:
  type: github
  admin:
    access: true
    users: [zonca, otherusername]
  github:
    clientId: "xxxxxxxxxxxxxxxxxxxx"
    clientSecret: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    callbackUrl: "https://js-xxx-xxx.jetstream-cloud.org/hub/oauth_callback"
</code></pre></div></div>

<h2 id="test-jupyterhub">Test Jupyterhub</h2>

<p>Connect to the master node with your browser at: <code class="language-plaintext highlighter-rouge">https://js-xxx-xxx.jetstream-cloud.org</code>
Login with your Github credentials, you should get a Jupyter Notebook.</p>

<p>You can also check that your pod is running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo kubectl get pods -n pangeo
NAME                                  READY     STATUS    RESTARTS   AGE
jupyter-zonca                         1/1       Running   0          2m
......other pods
</code></pre></div></div>

<h2 id="install-dask">Install Dask</h2>

<p>We want to deploy a single dask cluster that all the users can submit jobs to.</p>

<p>Customize the <code class="language-plaintext highlighter-rouge">dask_shared/dask_config.yaml</code> file available in the repository,
for testing purposes I set just 1 GB RAM and 1 CPU limits on each of 3 workers.
We can change <code class="language-plaintext highlighter-rouge">replicas</code> of the workers to add more.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo helm install stable/dask --name=dask --namespace=pangeo -f dask_config.yaml
</code></pre></div></div>

<p>Then check that the <code class="language-plaintext highlighter-rouge">dask</code> instances are running:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo kubectl get pods --namespace pangeo
NAME                              READY     STATUS    RESTARTS   AGE
dask-jupyter-647bdc8c6d-mqhr4     1/1       Running   0          22m
dask-scheduler-5d98cbf54c-4rtdr   1/1       Running   0          22m
dask-worker-6457975f74-dqhsh      1/1       Running   0          22m
dask-worker-6457975f74-lpvk4      1/1       Running   0          22m
dask-worker-6457975f74-xzcmc      1/1       Running   0          22m
hub-7f75b59fc5-8c2pg              1/1       Running   0          6d
jupyter-zonca                     1/1       Running   0          10m
proxy-6bbf67f6bd-swt7f            2/2       Running   0          6d
</code></pre></div></div>

<h3 id="access-the-scheduler-and-launch-a-distributed-job">Access the scheduler and launch a distributed job</h3>

<p><code class="language-plaintext highlighter-rouge">kube-dns</code> gives a name to each service and automatically propagates it to each pod, so we can connect by name</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from dask.distributed import Client
client = Client("dask-scheduler:8786")
client
</code></pre></div></div>

<p>Now we can access the 3 workers that we launched before:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Client
Scheduler: tcp://dask-scheduler:8786
Dashboard: http://dask-scheduler:8787/status
Cluster
Workers: 3
Cores: 6
Memory: 12.43 GB
</code></pre></div></div>

<p>We can run an example computation with dask array:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import dask.array as da
x = da.random.random((20000, 20000), chunks=(2000, 2000)).persist()
x.sum().compute()
</code></pre></div></div>

<h3 id="access-the-dask-dashboard-for-monitoring-job-execution">Access the Dask dashboard for monitoring job execution</h3>

<p>We need to setup ingress so that a path points to the Dask dashboard instead of Jupyterhub,</p>

<p>Checkout the file <code class="language-plaintext highlighter-rouge">dask_shared/dask_webui_ingress.yaml</code> in the repository, it routes the path <code class="language-plaintext highlighter-rouge">/dask</code>
to the <code class="language-plaintext highlighter-rouge">dask-scheduler</code> service.</p>

<p>Create the ingress resource with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo kubectl create ingress -n pangeo -f dask_webui_ingress.yaml
</code></pre></div></div>

<p>All users can now access the dashboard at:</p>

<ul>
  <li><a href="https://js-xxx-xxx.jetstream-cloud.org/dask/status">https://js-xxx-xxx.jetstream-cloud.org/dask/status</a></li>
</ul>

<p>Make sure to use <code class="language-plaintext highlighter-rouge">/dask/status/</code> and not only <code class="language-plaintext highlighter-rouge">/dask</code>.
Currently this is not authenticated, so this address is publicly available.
A simple way to hide it is to choose a custom name instead of <code class="language-plaintext highlighter-rouge">/dask</code> and edit
the ingress accordingly with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo kubectl edit ingress dask -n pangeo
</code></pre></div></div>

  </div><a class="u-url" href="/2018/05/shared-dask-kubernetes-jetstream.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

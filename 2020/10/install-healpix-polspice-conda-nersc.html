<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Install HEALPix and PolSpice in a conda environment | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Install HEALPix and PolSpice in a conda environment" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that." />
<meta property="og:description" content="Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that." />
<link rel="canonical" href="https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html" />
<meta property="og:url" content="https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-14T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Install HEALPix and PolSpice in a conda environment","dateModified":"2020-10-14T00:00:00-05:00","datePublished":"2020-10-14T00:00:00-05:00","description":"Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that.","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html"},"@type":"BlogPosting","url":"https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Install HEALPix and PolSpice in a conda environment | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Install HEALPix and PolSpice in a conda environment" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that." />
<meta property="og:description" content="Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that." />
<link rel="canonical" href="https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html" />
<meta property="og:url" content="https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-14T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Install HEALPix and PolSpice in a conda environment","dateModified":"2020-10-14T00:00:00-05:00","datePublished":"2020-10-14T00:00:00-05:00","description":"Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that.","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html"},"@type":"BlogPosting","url":"https://zonca.dev/2020/10/install-healpix-polspice-conda-nersc.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Install HEALPix and PolSpice in a conda environment</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-10-14T00:00:00-05:00" itemprop="datePublished">
        Oct 14, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#conda">conda</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#healpy">healpy</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#nersc">nersc</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Some notes on how to install HEALPix and PolSpice inside a conda environment,
with some details about doing it at NERSC, but most of the tutorial is independent of that.</p>

<h2 id="setup-the-conda-environment-and-the-compilers">Setup the conda environment and the compilers</h2>

<p>I assume here we are installing it into a custom conda environement
the possibly contains all other cosmology packages, like <code class="highlighter-rouge">healpy</code>.</p>

<p>For example created with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load python
conda create -n pycmb python==3.7 healpy matplotlib ipykernel
</code></pre></div></div>

<p>When you activate the conda environment, the variable <code class="highlighter-rouge">$CONDA_PREFIX</code> is
automatically set to the base folder of the environment,
something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~/anaconda/envs/pycmb
</code></pre></div></div>

<p>To make it simpler, I am using <code class="highlighter-rouge">gcc</code> and <code class="highlighter-rouge">gfortran</code>, if at NERSC run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load PrgEnv-gnu
</code></pre></div></div>

<p>if that fails, probably you need first to unload the Intel environment:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module unload PrgEnv-intel
module load PrgEnv-gnu
</code></pre></div></div>

<h2 id="install-cfitsio">Install cfitsio</h2>

<p><code class="highlighter-rouge">cfitsio</code> is quite easy, better download the version included in
<code class="highlighter-rouge">healpy</code> because it has a couple of fixes:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/healpy/cfitsio
cd cfitsio
</code></pre></div></div>

<p>We want to install it into a dedicated folder, not the same <code class="highlighter-rouge">lib</code> folder
of the conda environment, so that we don’t risk to have conflicts
with the compiler libraries during the build process:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configure --prefix=$CONDA_PREFIX/cfitsio
make -j8 shared install
</code></pre></div></div>

<h2 id="install-healpix">Install HEALPix</h2>

<p>HEALPix installs itself in the same folder where it is unpacked, and then modifies the bash
profile to make things work.
As we want to keep things isolated, let’s unpack the Healpix package into the conda environment folder, so it will be something like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CONDA_PREFIX/Healpix_3.70

./configure
</code></pre></div></div>

<p>configure the C, the Fortran packages, the Fortran package requires <code class="highlighter-rouge">libsharp</code>,
set everything to default except location of <code class="highlighter-rouge">cfitsio</code> where you need (notice <code class="highlighter-rouge">lib</code> at the end):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$CONDA_PREFIX/cfitsio/lib
</code></pre></div></div>

<p>When the installer asks whether to modify <code class="highlighter-rouge">.profile</code> respond no.
Now the installer will create some scripts in the <code class="highlighter-rouge">~/.healpix</code> folder and modify <code class="highlighter-rouge">.profile</code>, we want to only activate HEALPix in our conda environment so we should modify <code class="highlighter-rouge">.profile</code> and remove the lines added by HEALPix.</p>

<p>Finally we can have HEALPix automatically activated when the conda environment is initialized (notice we need the script to end in <code class="highlighter-rouge">.sh</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p ${CONDA_PREFIX}/etc/conda/activate.d
ln -s ~/.healpix/3_70_Linux/config ${CONDA_PREFIX}/etc/conda/activate.d/config.sh
</code></pre></div></div>

<p>Restart the conda environment, and try to run <code class="highlighter-rouge">anafast</code> to check that it works.
If you are at NERSC, make sure that you are always loading the GNU programming environment by having:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module swap PrgEnv-intel PrgEnv-gnu
</code></pre></div></div>

<p>in <code class="highlighter-rouge">.bashrc.ext</code>.</p>

<h2 id="install-polspice">Install PolSpice</h2>

<p>Create a <code class="highlighter-rouge">build</code> folder inside the source folder and create a <code class="highlighter-rouge">run.sh</code> file with this content:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmake .. -DCFITSIO=${CONDA_PREFIX}/cfitsio/lib -DCMAKE_Fortran_COMPILER=gfortran -DCMAKE_C_COMPILER=gcc
</code></pre></div></div>

<p>Then:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash run.sh
make -j8
</code></pre></div></div>

<p>This will put the <code class="highlighter-rouge">spice</code> executable into the <code class="highlighter-rouge">../bin</code> folder, just copy it to the conda environment bin folder:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ..
ln -s $(pwd)/bin/spice ${CONDA_PREFIX}/bin/
</code></pre></div></div>

<p>We can also copy the 2 python modules into the environment:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s $(pwd)/bin_llcl.py $(pwd)/ispice.py ${CONDA_PREFIX}/lib/python3.*/site-packages/
</code></pre></div></div>

<p>Check it works:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spice -usage
</code></pre></div></div>

  </div><a class="u-url" href="/2020/10/install-healpix-polspice-conda-nersc.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deploy Kubernetes and JupyterHub on Jetstream with Magnum | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Deploy Kubernetes and JupyterHub on Jetstream with Magnum" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This tutorial deploys Kubernetes on Jetstream with Magnum and then JupyterHub on top of that using zero-to-jupyterhub." />
<meta property="og:description" content="This tutorial deploys Kubernetes on Jetstream with Magnum and then JupyterHub on top of that using zero-to-jupyterhub." />
<link rel="canonical" href="https://zonca.dev/2020/05/kubernetes-jupyterhub-jetstream-magnum.html" />
<meta property="og:url" content="https://zonca.dev/2020/05/kubernetes-jupyterhub-jetstream-magnum.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-21T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Deploy Kubernetes and JupyterHub on Jetstream with Magnum","url":"https://zonca.dev/2020/05/kubernetes-jupyterhub-jetstream-magnum.html","dateModified":"2020-05-21T00:00:00-05:00","datePublished":"2020-05-21T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2020/05/kubernetes-jupyterhub-jetstream-magnum.html"},"description":"This tutorial deploys Kubernetes on Jetstream with Magnum and then JupyterHub on top of that using zero-to-jupyterhub.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploy Kubernetes and JupyterHub on Jetstream with Magnum</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-05-21T00:00:00-05:00" itemprop="datePublished">
        May 21, 2020
      </time>
    </p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#kubernetes">kubernetes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#openstack">openstack</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream">jetstream</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jupyterhub">jupyterhub</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2020-05-21-jetstream_kubernetes_magnum.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>This tutorial deploys Kubernetes on Jetstream with Magnum and then
JupyterHub on top of that using <a href="https://zero-to-jupyterhub.readthedocs.io/">zero-to-jupyterhub</a>.</p>

<p>This is an updated version of the <a href="https://zonca.dev/2019/06/kubernetes-jupyterhub-jetstream-magnum.html">Kubernetes on Jetstream with Magnum tutorial</a> based now on Kubernetes 1.15.7 instead of Kubernetes 1.11, the node images are based on Fedora Atomic 29 and the Jetstream Magnum deployment is now updated to the Openstack Train release.
If you need a newer version of Kubernetes, you can install Kubernetes with Kubespray instead, see <a href="https://zonca.dev/2020/06/kubernetes-jetstream-kubespray.html">this tutorial</a>.</p>

<h2 id="setup-access-to-the-jetstream-api">Setup access to the Jetstream API</h2>

<p>First install the OpenStack client, please use these exact versions, also please run at Indiana, the TACC deployment has an older release of Openstack.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install python-openstackclient==3.18 python-magnumclient==2.10
</code></pre></div></div>

<p>Load your API credentials from <code class="language-plaintext highlighter-rouge">openrc.sh</code>, check <a href="https://iujetstream.atlassian.net/wiki/spaces/JWT/pages/39682064/Setting+up+openrc.sh">documentation of the Jetstream wiki for details</a>.</p>

<p>You need to have a keypair uploaded to Openstack, this just needs to be done once per account. See <a href="https://iujetstream.atlassian.net/wiki/spaces/JWT/pages/35913730/OpenStack+command+line">the Jetstream documentation</a> under the section “Upload SSH key - do this once”.</p>

<h2 id="create-the-cluster-with-magnum">Create the cluster with Magnum</h2>

<p>As usual, checkout the repository with all the configuration files on the machine you will use the Jetstream API from, typically your laptop.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream
cd jupyterhub-deploy-kubernetes-jetstream
cd kubernetes_magnum
</code></pre></div></div>

<p>Now we are ready to use Magnum to first create a cluster template and then the actual cluster, edit first <code class="language-plaintext highlighter-rouge">create_cluster.sh</code> and set the parameters of the cluster on the top. Also make sure to set the keypair name.
Create the network resources and the cluster template, these need to be created just
once, then they can be reused by clusters created later on:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash create_network.sh
bash create_template.sh
</code></pre></div></div>

<p>Then a cluster can be created with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash create_cluster.sh
</code></pre></div></div>

<p>The cluster consumes resources when active, it can be switched off with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash delete_cluster.sh
</code></pre></div></div>

<p>Consider this is deleting all Jetstream virtual machines and data that could be stored in JupyterHub.</p>

<p>I have setup a test cluster with only 1 master node and 1 normal node but you can modify that later.</p>

<p>Check the status of your cluster, after about 10 minutes, it should be in state <code class="language-plaintext highlighter-rouge">CREATE_COMPLETE</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack coe cluster show k8s
</code></pre></div></div>

<h3 id="configure-kubectl-locally">Configure kubectl locally</h3>

<p>Install the <code class="language-plaintext highlighter-rouge">kubectl</code> client locally, first check the version of the master node:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack server list # find the floating public IP of the master node (starts with 149_
IP=149.xxx.xxx.xxx
ssh fedora@$IP
kubectl version
</code></pre></div></div>

<p>Now install the same version following the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubernetes documentation</a></p>

<p>Now configure <code class="language-plaintext highlighter-rouge">kubectl</code> on your laptop to connect to the Kubernetes cluster created with Magnum:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir kubectl_secret
cd kubectl_secret
openstack coe cluster config k8s
</code></pre></div></div>

<p>This downloads a configuration file and the required certificates.</p>

<p>and returns  <code class="language-plaintext highlighter-rouge">export KUBECONFIG=/absolute/path/to/config</code></p>

<p>See also the <code class="language-plaintext highlighter-rouge">update_kubectl_secret.sh</code> script to automate this step, but it requires to already have setup the environment variable.</p>

<p>execute that and then:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>

<p>we can also verify the Kubernetes version available, it should now be <code class="language-plaintext highlighter-rouge">1.15.7</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl version
Server Version: version.Info{Major:"1", Minor:"15", GitVersion:"v1.15.7", GitCommit:"6c143d35bb11d74970e7bc0b6c45b6bfdffc0bd4", GitTreeState:"clean", BuildDate:"2019-12-11T12:34:17Z", GoVersion:"go1.12.12", Compiler:"gc", Platform:"linux/amd64"}
</code></pre></div></div>

<h2 id="configure-storage">Configure storage</h2>

<p>Magnum configures a provider that knows how to create Kubernetes volumes using Openstack Cinder,
but does not configure a <code class="language-plaintext highlighter-rouge">storageclass</code>, we can do that with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f storageclass.yaml
</code></pre></div></div>

<p>We can test this by creating a Persistent Volume Claim:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f persistent_volume_claim.yaml

kubectl describe pv

kubectl describe pvc
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Name:            pvc-e8b93455-898b-11e9-a37c-fa163efb4609
Labels:          failure-domain.beta.kubernetes.io/zone=nova
Annotations:     kubernetes.io/createdby: cinder-dynamic-provisioner
                 pv.kubernetes.io/bound-by-controller: yes
                 pv.kubernetes.io/provisioned-by: kubernetes.io/cinder
Finalizers:      [kubernetes.io/pv-protection]
StorageClass:    standard
Status:          Bound
Claim:           default/pvc-test
Reclaim Policy:  Delete
Access Modes:    RWO
Capacity:        5Gi
Node Affinity:   &lt;none&gt;
Message:
Source:
    Type:       Cinder (a Persistent Disk resource in OpenStack)
    VolumeID:   2795724b-ef11-4053-9922-d854107c731f
    FSType:
    ReadOnly:   false
    SecretRef:  nil
Events:         &lt;none&gt;
</code></pre></div></div>

<p>We can also test creating an actual pod with a persistent volume and check
that the volume is successfully mounted and the pod started:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f ../alpine-persistent-volume.yaml
kubectl describe pod alpine
</code></pre></div></div>

<h3 id="note-about-availability-zones">Note about availability zones</h3>

<p>By default Openstack servers and Openstack volumes are created in different availability zones. This created an issue with the default Magnum templates because we need to modify the Kubernetes scheduler policy to allow this. Kubespray does this by default, so I created a <a href="https://github.com/zonca/magnum/pull/2">fix to be applied to the Jetstream Magnum templates</a>, this needs to be re-applied after every Openstack upgrade. The Jetstream team has applied these fixes, they are linked here just for reference.</p>

<h2 id="install-helm">Install Helm</h2>

<p>The Kubernetes deployment from Magnum is not as complete as the one out of Kubespray, we need
to setup the NGINX ingress ourselves.</p>

<p><a href="https://helm.sh/docs/using_helm/#installing-helm">Install the Helm client on your laptop</a>,
make sure you install Helm 3 or later.</p>

<p>Run <code class="language-plaintext highlighter-rouge">helm ls</code> and make sure it doesn’t give any error message but just an empty result.</p>

<h2 id="setup-nginx-ingress">Setup NGINX ingress</h2>

<p>We need to have the NGINX web server to act as front-end to the services running inside the Kubernetes cluster.</p>

<h3 id="open-http-and-https-ports">Open HTTP and HTTPS ports</h3>

<p>First we need to open the HTTP and HTTPS ports on the master node, you can either connect to the Horizon interface,
create new rule named <code class="language-plaintext highlighter-rouge">http_https</code>, then add 2 rules, in the Rule drop down choose HTTP and HTTPS; or from the command line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack security group create http_https
openstack security group rule create --ingress --protocol tcp --dst-port 80 http_https
openstack security group rule create --ingress --protocol tcp --dst-port 443 http_https
</code></pre></div></div>

<p>Then you can find the name of the master node in <code class="language-plaintext highlighter-rouge">openstack server list</code> then add this security group to that instance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack server add security group  k8s-xxxxxxxxxxxx-master-0 http_https
</code></pre></div></div>

<h3 id="install-nginx-ingress-with-helm">Install NGINX ingress with Helm</h3>

<p>We prefer to run the NGINX ingress on the master node, in fact in the configuration in <code class="language-plaintext highlighter-rouge">nginx.yaml</code> specifies:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nodeSelector:
    node-role.kubernetes.io/master: ""
</code></pre></div></div>

<p>This is useful to reduce traffic across the cluster, install NGINX using Helm:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash install_nginx_ingress.sh
</code></pre></div></div>

<p>Note, the documentation says we should add this annotation to ingress with <code class="language-plaintext highlighter-rouge">kubectl edit ingress -n jhub</code>, but I found out it is not necessary:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
</code></pre></div></div>

<p>If this is correctly working, you should be able to run <code class="language-plaintext highlighter-rouge">curl localhost</code> from the master node and get a <code class="language-plaintext highlighter-rouge">Default backend: 404</code> message.</p>

<h2 id="install-jupyterhub">Install JupyterHub</h2>

<p>Finally, we can go back to the root of the repository and install JupyterHub, first create the secrets file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash create_secrets.sh
</code></pre></div></div>

<p>Then edit <code class="language-plaintext highlighter-rouge">secrets.yaml</code> and modify the hostname under <code class="language-plaintext highlighter-rouge">hosts</code> to display the hostname of your master Jetstream instance, i.e. if your instance public floating IP is <code class="language-plaintext highlighter-rouge">aaa.bbb.xxx.yyy</code>, the hostname should be <code class="language-plaintext highlighter-rouge">js-xxx-yyy.jetstream-cloud.org</code> (without <code class="language-plaintext highlighter-rouge">http://</code>).</p>

<p>You should also check that connecting with your browser to <code class="language-plaintext highlighter-rouge">js-xxx-yyy.jetstream-cloud.org</code> shows <code class="language-plaintext highlighter-rouge">default backend - 404</code>, this means NGINX is also reachable from the internet, i.e. the web port is open on the master node.</p>

<p>Finally:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash configure_helm_jupyterhub.sh
kubectl create namespace jhub
bash install_jhub.sh
</code></pre></div></div>

<p>Connect with your browser to <code class="language-plaintext highlighter-rouge">js-xxx-yyy.jetstream-cloud.org</code> to check if it works.</p>

<p>We are installing the <code class="language-plaintext highlighter-rouge">zero-to-jupyterhub</code> helm recipe version <code class="language-plaintext highlighter-rouge">0.9.0</code> instead of <code class="language-plaintext highlighter-rouge">0.8.2</code>.</p>

<h3 id="allow-services-on-master">Allow services on master</h3>

<p>By default the new Kubernetes version has 1 taint on the master node:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  taints:
  - effect: NoSchedule
    key: dedicated
    value: master
</code></pre></div></div>

<p>The JupyterHub recipe does not allow to automatically set tolerations on the hub and the proxy
pods, therefore if we want to run them on master, the easiest way is to delete that taint
from the master node:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl edit node NODENAME
</code></pre></div></div>

<h2 id="issues-and-feedback">Issues and feedback</h2>

<p>Please <a href="https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream/">open an issue on the repository</a> to report any issue or give feedback. Also you find out there there what I am working on next.</p>

<h2 id="acknowledgments">Acknowledgments</h2>

<p>Many thanks to Jeremy Fischer and Mike Lowe for upgrading the infrastructure to the new Magnum and Kubernetes versions and applying the necessary fixes.</p>

  </div><a class="u-url" href="/2020/05/kubernetes-jupyterhub-jetstream-magnum.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

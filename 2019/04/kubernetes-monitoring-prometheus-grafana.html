<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Kubernetes monitoring with Prometheus and Grafana | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Kubernetes monitoring with Prometheus and Grafana" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU." />
<meta property="og:description" content="In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU." />
<link rel="canonical" href="https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html" />
<meta property="og:url" content="https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-20T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU.","headline":"Kubernetes monitoring with Prometheus and Grafana","dateModified":"2019-04-20T00:00:00-05:00","datePublished":"2019-04-20T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html"},"url":"https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Kubernetes monitoring with Prometheus and Grafana | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Kubernetes monitoring with Prometheus and Grafana" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU." />
<meta property="og:description" content="In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU." />
<link rel="canonical" href="https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html" />
<meta property="og:url" content="https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-20T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively. Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana to access those data and provide real-time plotting and inspection capability. Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU.","headline":"Kubernetes monitoring with Prometheus and Grafana","dateModified":"2019-04-20T00:00:00-05:00","datePublished":"2019-04-20T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html"},"url":"https://zonca.dev/2019/04/kubernetes-monitoring-prometheus-grafana.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Kubernetes monitoring with Prometheus and Grafana</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2019-04-20T00:00:00-05:00" itemprop="datePublished">
        Apr 20, 2019
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      3 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#kubernetes">kubernetes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#kubespray">kubespray</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream">jetstream</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jupyterhub">jupyterhub</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In a production Kubernetes deployment it is necessary to make it easier to monitor the status of the cluster effectively.
Kubernetes provides Prometheus to gather data from the different components of Kubernetes and Grafana
to access those data and provide real-time plotting and inspection capability.
Moreover, they both provide systems to send alerts in case some conditions on the state of the cluster are met, i.e. using more than 90% of RAM or CPU.</p>

<p>The only downside is that the pods that handle monitoring consume some resource themselves, so this could be significant for small clusters below 5 nodes or so, but shouldn’t be a problem for typical larger production deployments.</p>

<p>Both Prometheus and Grafana can be installed separately with Helm recipes or using the Prometheus operator Helm recipe,
however those deployments do not have any preconfigured dashboards, it is easier to get started thanks to the <code class="highlighter-rouge">kube-prometheus</code> project,
which not only installs Prometheus and Grafana, but also preconfigures about 10 different Grafana dashboards to explore in depth
the status of a Kubernetes cluster.</p>

<p>The main issue is that customizing it is really complicated, it requires modifying <code class="highlighter-rouge">jsonnet</code> templates and recompiling them with a <code class="highlighter-rouge">jsonnet</code> builder which requires <code class="highlighter-rouge">go</code>, however I don’t foresee the need to do that for most users.</p>

<p>Unfortunately it is not based on Helm, so you need to first checkout the repository:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/coreos/kube-prometheus
</code></pre></div></div>

<p>and then follow the instructions <a href="https://github.com/coreos/kube-prometheus#quickstart">in the documentation</a>,
copied here for convenience:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f manifests/
</code></pre></div></div>

<p>wait a moment, do not worry if some of the tasks fails, they should get fixed running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply -f manifests/
</code></pre></div></div>

<p>This creates several pods in the <code class="highlighter-rouge">monitoring</code> namespace:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -n monitoring
NAME                                   READY   STATUS    RESTARTS   AGE
alertmanager-main-0                    2/2     Running   0          13m
alertmanager-main-1                    2/2     Running   0          13m
alertmanager-main-2                    2/2     Running   0          13m
grafana-9d97dfdc7-zkfft                1/1     Running   0          14m
kube-state-metrics-7c7979b6bc-srcvk    4/4     Running   0          12m
node-exporter-b6n2w                    2/2     Running   0          14m
node-exporter-cgp46                    2/2     Running   0          14m
prometheus-adapter-b7d894c9c-z2ph7     1/1     Running   0          14m
prometheus-k8s-0                       3/3     Running   1          13m
prometheus-k8s-1                       3/3     Running   1          13m
prometheus-operator-65c44fb7b7-8ltzs   1/1     Running   0          14m
</code></pre></div></div>

<p>Then you can setup forwarding on your laptop to export grafana locally:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl --namespace monitoring port-forward svc/grafana 3000
</code></pre></div></div>

<p>Access <code class="highlighter-rouge">localhost:3000</code> with your browser and you should be able to navigate through all the statistics of your cluster,
see for example this screenshot. The credentials are user <code class="highlighter-rouge">admin</code> and password <code class="highlighter-rouge">admin</code>.</p>

<p><img src="/images/grafana.png" alt="Screenshot of the Grafana UI" /></p>

<h2 id="access-the-ui-from-a-different-machine">Access the UI from a different machine</h2>

<p>In case you are running the configuration on a remote server and you would like to access the Grafana UI (or any other service) from your laptop, you can install <code class="highlighter-rouge">kubectl</code> also your my laptop, then copy the <code class="highlighter-rouge">.kube/config</code> to the laptop with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> scp -r KUBECTLMACHINE:~/.kube/config ~/.kube
</code></pre></div></div>

<p>and run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ssh ubuntu@$IP -f -L 6443:localhost:6443 sleep 3h &amp;
</code></pre></div></div>

<p>from the laptop and then run the <code class="highlighter-rouge">port-forward</code> command locally on the laptop.</p>

<h2 id="monitor-jupyterhub">Monitor JupyterHub</h2>

<p>Once we have <a href="https://zonca.github.io/2019/02/kubernetes-jupyterhub-jetstream-kubespray.html">deployed JupyterHub with Helm</a>, we can pull up the
“namespace” monitor and select the <code class="highlighter-rouge">jhub</code> namespace to visualize resource usage but also usage requests and limits of all pods created by JupyterHub and its users. See a screenshot below.</p>

<p><img src="/images/grafana_jhub.png" alt="Screenshot of the Grafana namespace UI" /></p>

<h2 id="setup-alerts">Setup alerts</h2>

<p>Grafana supports email alerts, but it needs a SMTP server, and it is not easy to setup and to avoid being filtered as spam.
The easiest way is to setup an alert to Slack, and optionally be notified via email of Slack messages.</p>

<p>Follow the <a href="https://grafana.com/docs/alerting/notifications/#slack">instructions for slack on the Grafana documentation</a></p>

<ul>
  <li>Create a Slack app, name it e.g. Grafana</li>
  <li>Add feature “Incoming webhook”</li>
  <li>Create a incoming webhook in the workspace and channel your prefer on Slack</li>
  <li>In the Grafana Alerting menu, set the webhook incoming url, the channel name</li>
</ul>

<p><img src="/images/grafana_slack.png" alt="Screenshot of the Grafana slack notification" /></p>

  </div><a class="u-url" href="/2019/04/kubernetes-monitoring-prometheus-grafana.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

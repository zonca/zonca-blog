<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Simulate users on JupyterHub | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Simulate users on JupyterHub" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Updated January 2021" />
<meta property="og:description" content="Updated January 2021" />
<link rel="canonical" href="https://zonca.dev/2019/10/loadtest-jupyterhub.html" />
<meta property="og:url" content="https://zonca.dev/2019/10/loadtest-jupyterhub.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-30T12:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Simulate users on JupyterHub","url":"https://zonca.dev/2019/10/loadtest-jupyterhub.html","dateModified":"2019-10-30T12:00:00-05:00","datePublished":"2019-10-30T12:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2019/10/loadtest-jupyterhub.html"},"description":"Updated January 2021","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Simulate users on JupyterHub</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2019-10-30T12:00:00-05:00" itemprop="datePublished">
        Oct 30, 2019
      </time>
    </p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#kubernetes">kubernetes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#openstack">openstack</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream">jetstream</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jupyterhub">jupyterhub</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2019-10-30-jetstream_kubernetes_loadtest.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><strong>Updated January 2021</strong></p>

<p>I currently have 2 different strategies to deploy JupyterHub on top of Kubernetes on Jetstream:</p>

<ul>
  <li>Using <a href="https://zonca.github.io/2019/02/kubernetes-jupyterhub-jetstream-kubespray.html">Kubespray</a></li>
  <li>Using <a href="http://zonca.github.io/2019/06/kubernetes-jupyterhub-jetstream-magnum.html">Magnum</a>, which also supports the <a href="http://zonca.github.io/2019/09/kubernetes-jetstream-autoscaler.html">Cluster Autoscaler</a></li>
</ul>

<p>In this tutorial I’ll show how to use Yuvi Pandas’ <a href="https://github.com/yuvipanda/hubtraf"><code class="language-plaintext highlighter-rouge">hubtraf</code></a> to simulate load on JupyterHub, i.e. programmatically generate a predefined number of users connecting and executing notebooks on the system.</p>

<p>This is especially useful to test the Cluster Autoscaler.</p>

<p><code class="language-plaintext highlighter-rouge">hubtraf</code> assumes you are using the Dummy authenticator, which is the default installed by the <code class="language-plaintext highlighter-rouge">zero-to-jupyterhub</code> helm chart. If you have configured another authenticator, temporarily disable it for testing purposes.</p>

<p>First go through the <a href="https://github.com/yuvipanda/hubtraf/blob/master/docs/index.rst#jupyterhub-traffic-simulator"><code class="language-plaintext highlighter-rouge">hubtraf</code> documentation</a> to understand its functionalities.</p>

<p><code class="language-plaintext highlighter-rouge">hubtraf</code> also has a Helm recipe to run it within Kubernetes, but the simpler way is to test from your laptop, follow the [documentation of <code class="language-plaintext highlighter-rouge">hubtraf</code>] to install the package and then run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>URL=http://js-xxx-yyy.jetstream-cloud.org
hubtraf-simulate $URL 2
</code></pre></div></div>

<p>To simulate 2 users connecting to the system, you can then check with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -n jhub
</code></pre></div></div>

<p>That the pods are being created successfully and check the logs on the command line from <code class="language-plaintext highlighter-rouge">hubtraf</code> which explains what it is doing and tracks the time every operation takes, so it is useful to debug any delay in providing resources to users.</p>

<p>Consider that volumes created by JupyterHub for the test users will remain in Kubernetes and in Openstack, therefore if you would like to use the same deployment for production, remember to cleanup the Kubernetes <code class="language-plaintext highlighter-rouge">PersistentVolume</code> and <code class="language-plaintext highlighter-rouge">PersistentVolumeClaim</code> resources.</p>

<p>Now we can test scalability of the deployment with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    hubtraf http://js-xxx-yyy.jetstream-cloud.org 100
</code></pre></div></div>

<p>Make sure you have asked the XSEDE support to increase the maximum number of volumes in Openstack in your allocation that by default is only 10. Otherwise edit <code class="language-plaintext highlighter-rouge">config_standard_storage.yaml</code> and set:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>singleuser:
  storage:
    type: none
</code></pre></div></div>

<h2 id="test-the-cluster-autoscaler">Test the Cluster Autoscaler</h2>

<p>If you followed the tutorial to deploy the Cluster Autoscaler on Magnum, you can launch <code class="language-plaintext highlighter-rouge">hubtraf</code> to create a large number of pods, then check that some pods are “Running” and the ones that do not fit in the current nodes are “Pending”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -n jhub
</code></pre></div></div>

<p>and then check in the logs of the autoscaler that it detects that those pods are pending and requests additional nodes.
For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> kubectl logs <span class="nt">-n</span> kube-system cluster-autoscaler-hhhhhhh-uuuuuuu
I1031 00:48:39.807384       1 scale_up.go:689] Scale-up: setting group DefaultNodeGroup size to 2
I1031 00:48:41.583449       1 magnum_nodegroup.go:101] Increasing size by 1, 1-&gt;2
I1031 00:49:14.141351       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_IN_PROGRESS status
</code></pre></div></div>

<p>After 4 or 5 minutes the new node should be available and should show up in:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get nodes
</code></pre></div></div>

<p>And we can check that some user pods are now running on the new node:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pods -n jhub -o wide
</code></pre></div></div>

<p>In my case the Autoscaler actually requested a 3rd node to accomodate all the users pods:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I1031 00:48:39.807384       1 scale_up.go:689] Scale-up: setting group DefaultNodeGroup size to 2
I1031 00:48:41.583449       1 magnum_nodegroup.go:101] Increasing size by 1, 1-&gt;2
I1031 00:49:14.141351       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_IN_PROGRESS status
I1031 00:52:51.308054       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_COMPLETE status
I1031 00:53:01.315179       1 scale_up.go:689] Scale-up: setting group DefaultNodeGroup size to 3
I1031 00:53:02.996583       1 magnum_nodegroup.go:101] Increasing size by 1, 2-&gt;3
I1031 00:53:35.607158       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_IN_PROGRESS status
I1031 00:56:41.834151       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_COMPLETE status
</code></pre></div></div>

<p>Moreover Cluster Autoscaler also provides useful information in the status of each “Pending” node. For example if it detects that it is useless to create a new node because the node is “Pending” for some other reason (e.g. volume quota reached), this infomation will be accessible using:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe node -n jhub jupyter-xxxxxxx
</code></pre></div></div>

<p>When the simulated users disconnect, <code class="language-plaintext highlighter-rouge">hubtraf</code> has a default of about 5 minutes, the autoscaler waits for the configured amount of minutes, by default it is 10 minutes, in my deployment it is 1 minute to simplify testing, see the <code class="language-plaintext highlighter-rouge">cluster-autoscaler-deployment-master.yaml</code> file.
After this delay, the autoscaler scales down the size of the cluster, it is a 2 step process, it first terminates the Openstack Virtual machine and then adjusts the size of the Magnum cluster (<code class="language-plaintext highlighter-rouge">node_count</code>), you can monitor the process using <code class="language-plaintext highlighter-rouge">openstack server list</code> and <code class="language-plaintext highlighter-rouge">openstack coe cluster list</code>, and the log of the autoscaler:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>I1101 06:31:10.223660       1 scale_down.go:882] Scale-down: removing empty node k8s-e2iw7axmhym7-minion-1 
I1101 06:31:16.081223       1 magnum_manager_heat.go:276] Waited <span class="k">for </span>stack UPDATE_IN_PROGRESS status
I1101 06:32:17.061860       1 magnum_manager_heat.go:276] Waited <span class="k">for </span>stack UPDATE_COMPLETE status
I1101 06:32:49.826439       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_IN_PROGRESS status
I1101 06:33:21.588022       1 magnum_nodegroup.go:67] Waited <span class="k">for </span>cluster UPDATE_COMPLETE status
</code></pre></div></div>

<h2 id="acknowledgments">Acknowledgments</h2>

<p>Thanks Yuvi Panda for providing <code class="language-plaintext highlighter-rouge">hubtraf</code>, thanks Julien Chastang for testing my deployments.</p>

  </div><a class="u-url" href="/2019/10/loadtest-jupyterhub.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

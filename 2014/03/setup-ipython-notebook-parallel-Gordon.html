<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Python on Gordon | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Python on Gordon" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gordon has already a python environment setup which can be activated by loading the python module:" />
<meta property="og:description" content="Gordon has already a python environment setup which can be activated by loading the python module:" />
<link rel="canonical" href="https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html" />
<meta property="og:url" content="https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-20T19:30:00-05:00" />
<script type="application/ld+json">
{"headline":"Python on Gordon","dateModified":"2014-03-20T19:30:00-05:00","datePublished":"2014-03-20T19:30:00-05:00","description":"Gordon has already a python environment setup which can be activated by loading the python module:","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html"},"@type":"BlogPosting","url":"https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Python on Gordon | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Python on Gordon" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gordon has already a python environment setup which can be activated by loading the python module:" />
<meta property="og:description" content="Gordon has already a python environment setup which can be activated by loading the python module:" />
<link rel="canonical" href="https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html" />
<meta property="og:url" content="https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-20T19:30:00-05:00" />
<script type="application/ld+json">
{"headline":"Python on Gordon","dateModified":"2014-03-20T19:30:00-05:00","datePublished":"2014-03-20T19:30:00-05:00","description":"Gordon has already a python environment setup which can be activated by loading the python module:","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html"},"@type":"BlogPosting","url":"https://zonca.dev/2014/03/setup-ipython-notebook-parallel-Gordon.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Python on Gordon</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2014-03-20T19:30:00-05:00" itemprop="datePublished">
        Mar 20, 2014
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      4 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#hpc">hpc</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#python">python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#Gordon">Gordon</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Gordon has already a <code class="highlighter-rouge">python</code> environment setup which can be activated by loading the <code class="highlighter-rouge">python</code> module:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load python # add this to .bashrc to load it at every login
</code></pre></div></div>

<h3 id="install-virtualenv">Install virtualenv</h3>

<p>Then we need to setup a sandboxed local environment to install other packages, by using <code class="highlighter-rouge">virtualenv</code>, get the link to the latest version from <a href="https://pypi.python.org/pypi/virtualenv">https://pypi.python.org/pypi/virtualenv</a>, then download it on gordon and unpack it, e.g.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget --no-check-certificate https://pypi.python.org/packages/source/v/virtualenv/virtualenv-1.11.2.tar.gz
tar xzvf virtualenv*tar.gz
</code></pre></div></div>

<p>Then create your own virtualenv and load it:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/venv
python virtualenv-*/virtualenv.py ~/venv/py
source ~/venv/py/bin/activate # add this to .bashrc to load it at every login
</code></pre></div></div>

<p>you can restore your previous environment by deactivating the virtualenv:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>deactivate # from your bash prompt
</code></pre></div></div>

<h3 id="install-ipython">Install IPython</h3>

<p>Using <code class="highlighter-rouge">pip</code> you can install <code class="highlighter-rouge">IPython</code> and all dependencies for the notebook and parallel tools running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install ipython pyzmq tornado jinja
</code></pre></div></div>

<h3 id="configure-the-ipython-notebook">Configure the IPython notebook</h3>
<p>For interactive data exploration, you can run the <code class="highlighter-rouge">IPython</code> notebook in a computing node on Gordon and export the web interface to your local machine, which also embeds all the plots.
Configuring the tunnelling over SSH is complicated, so I created a script, takes a little time to setup but then is very easy to use, see https://github.com/pyHPC/ipynbhpc.</p>

<h3 id="configure-ipython-parallel">Configure IPython parallel</h3>
<p><a href="http://ipython.org/ipython-doc/stable/parallel/">IPython parallel</a> on Gordon allows to launch a <code class="highlighter-rouge">PBS</code> job with tens (or hundreds) of Python engines and then easily submit hundreds (or thousands) of serial jobs to be executed with automatic load balancing.
First of all create the default configuration files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipython profile create --parallel  Then, in `~/.ipython/profile_default/ipcluster_config.py`, you need to setup:

c.IPClusterStart.controller_launcher_class = 'LocalControllerLauncher' 
c.IPClusterStart.engine_launcher_class = 'PBS' 
c.PBSLauncher.batch_template_file = u'/home/REPLACEWITHYOURUSER/.ipython/profile_default/pbs.engine.template' # "~" does not work
</code></pre></div></div>

<p>You also need to allow connections to the controller from other hosts, setting  in <code class="highlighter-rouge">~/.ipython/profile_default/ipcontroller_config.py</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c.HubFactory.ip = '*'
c.HubFactory.engine_ip = '*'
</code></pre></div></div>

<p>Finally create the PBS template <code class="highlighter-rouge">~/.ipython/profile_default/pbs.engine.template</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#PBS -q normal</span>
<span class="c">#PBS -N ipcluster</span>
<span class="c">#PBS -l nodes={n/16}:ppn={n}:native</span>
<span class="c">#PBS -l walltime=01:00:00</span>
<span class="c">#PBS -o ipcluster.out</span>
<span class="c">#PBS -e ipcluster.err</span>
<span class="c">#PBS -m abe</span>
<span class="c">#PBS -V</span>
mpirun_rsh <span class="nt">-np</span> <span class="o">{</span>n<span class="o">}</span> <span class="nt">-hostfile</span> <span class="nv">$PBS_NODEFILE</span> ipengine
</code></pre></div></div>

<p>Here we chose to run 16 IPython engines per Gordon node, so each has access to 4GB of ram, if you need more just change 16 to 8 for example.</p>

<h3 id="run-ipython-parallel">Run IPython parallel</h3>

<p>You can submit a job to the queue running, <code class="highlighter-rouge">n</code> is equal to the number of processes you want to use, so it needs to be a multiple of the <code class="highlighter-rouge">ppn</code> chosen in the PBS template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipcluster start --n=32 &amp;
</code></pre></div></div>

<p>in this case we are requesting 2 nodes, with 16 IPython engines each, check with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qstat -u $USER
</code></pre></div></div>

<p>basically <code class="highlighter-rouge">ipcluster</code> runs an <code class="highlighter-rouge">ipcontroller</code> on the login node and submits a job to PBS for running the <code class="highlighter-rouge">ipengines</code> on the computing nodes.</p>

<p>Once the PBS job is running, check that the engines are connected by opening a IPython on the login node and print the <code class="highlighter-rouge">ids</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In [1]: from IPython.parallel import Client
In [2]: rc = Client()
In [3]: rc.ids
</code></pre></div></div>

<p>You can stop the cluster (kills <code class="highlighter-rouge">ipcontroller</code> and runs <code class="highlighter-rouge">qdel</code> on the PBS job) either by sending CTRL-c to <code class="highlighter-rouge">ipcluster</code> or running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipcluster stop # from bash console
</code></pre></div></div>

<h3 id="submit-jobs-to-ipython-parallel">Submit jobs to IPython parallel</h3>

<p>As soon as <code class="highlighter-rouge">ipcluster</code> is executed, <code class="highlighter-rouge">ipcontroller</code> is ready to queue jobs up, which will be then consumed by the engines once they will be running.
The easiest method to submit jobs with automatic load balancing is to create a load balanced view:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>In [1]: from IPython.parallel import Client
In [2]: rc = Client()
In [3]: lview = rc.load_balanced_view() # default load-balanced view
</code></pre></div></div>

<p>and then use its <code class="highlighter-rouge">map</code> method:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def exp_10(x):
	return x**10
    
list_of_args = range(100)
result = lview.map(exp_10, list_of_args)
</code></pre></div></div>

<p>In this code <code class="highlighter-rouge">IPython</code> will distribute uniformly the list of arguments to the engines and the function will be evalutated for each of them and the result copied back to the connecting client running on the login node.</p>

<h3 id="submit-non-python-jobs-to-ipython-parallel">Submit non-python jobs to IPython parallel</h3>
<p>Let’s assume you have a list of commands you want to run in a text file, one command per line, those could be implemented in any programming language, e.g.:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>date &amp;&gt; date.log
hostname &amp;&gt; hostname.log
</code></pre></div></div>

<p>Then you create a function that executes one of those commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def run_command(command):
    import subprocess
    subprocess.Popen(command, shell = True)
</code></pre></div></div>

<p>Then apply this function to the list of commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>list_of_commands = open("commands.txt").readlines()
lview.map(run_command, list_of_commands)
</code></pre></div></div>

<p>I created a script that automates this process, see https://gist.github.com/zonca/8994544, you can run as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./ipcluster_run_commands.py commands.txt
</code></pre></div></div>


  </div><a class="u-url" href="/2014/03/setup-ipython-notebook-parallel-Gordon.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>

<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Custos authentication for JupyterHub | Andrea Zonca</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Custos authentication for JupyterHub" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Custos is a security middleware used to authenticate users to Airavata-based Science Gateways. It is relevant to the Science Gateways community to unify authentication and also authenticate users to JupyterHub using the same framework." />
<meta property="og:description" content="Custos is a security middleware used to authenticate users to Airavata-based Science Gateways. It is relevant to the Science Gateways community to unify authentication and also authenticate users to JupyterHub using the same framework." />
<link rel="canonical" href="https://zonca.dev/2022/04/jupyterhub-custos-authentication.html" />
<meta property="og:url" content="https://zonca.dev/2022/04/jupyterhub-custos-authentication.html" />
<meta property="og:site_name" content="Andrea Zonca" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-04-13T00:00:00-05:00" />
<script type="application/ld+json">
{"headline":"Custos authentication for JupyterHub","url":"https://zonca.dev/2022/04/jupyterhub-custos-authentication.html","dateModified":"2022-04-13T00:00:00-05:00","datePublished":"2022-04-13T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zonca.dev/2022/04/jupyterhub-custos-authentication.html"},"description":"Custos is a security middleware used to authenticate users to Airavata-based Science Gateways. It is relevant to the Science Gateways community to unify authentication and also authenticate users to JupyterHub using the same framework.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://zonca.dev/feed.xml" title="Andrea Zonca" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Andrea Zonca</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/consult/">Consulting</a><a class="page-link" href="/search/">Search</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Custos authentication for JupyterHub</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-04-13T00:00:00-05:00" itemprop="datePublished">
        Apr 13, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#kubernetes">kubernetes</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#openstack">openstack</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jetstream2">jetstream2</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#jupyterhub">jupyterhub</a>
        
      
      </p>
    

      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/zonca/zonca-blog/tree/master/_posts/2022-04-13-jupyterhub-custos-authentication.md" role="button" target="_blank">
<img class="notebook-badge-image" src="/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

    </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p><a href="https://airavata.apache.org/custos/">Custos</a> is a security middleware used to
authenticate users to Airavata-based Science Gateways.
It is relevant to the Science Gateways community to unify authentication and also
authenticate users to JupyterHub using the same framework.</p>

<p>Custos is a hosted solution managed by Indiana University, therefore it has no maintenance burden
and supports CILogon so that users can login with credentials from almost all US Higher Education
Institutions.</p>

<h2 id="requirements">Requirements</h2>

<p>I have been testing on Jetstream 2, however it should work easily on any Kubernetes deployment.
If you also are testing on Jetstream 2, you can follow my previous tutorials to:</p>

<ul>
  <li><a href="https://zonca.dev/2022/03/kubernetes-jetstream2-kubespray.html">Deploy Kubernetes</a></li>
  <li><a href="https://zonca.dev/2022/03/jetstream2-jupyterhub.html">Deploy JupyterHub</a></li>
  <li><a href="https://zonca.dev/2020/03/setup-https-kubernetes-letsencrypt.html">Deploy Cert-Manager for SSL support</a></li>
</ul>

<h2 id="configure-custos">Configure Custos</h2>

<p>First you can request a new tenant on the Custos hosted service, for testing you can use the development version at:</p>

<p><a href="https://dev.portal.usecustos.org/">https://dev.portal.usecustos.org/</a></p>

<p>then, for production, switch to:</p>

<p><a href="https://portal.usecustos.org/">https://portal.usecustos.org/</a></p>

<ul>
  <li>Login with CILogon (I tested using my XSEDE account)</li>
  <li>Click on create new tenant</li>
  <li>Redirect url <a href="https://your.jupyterhub.com/hub/oauth_callback">https://your.jupyterhub.com/hub/oauth_callback</a></li>
  <li>Domain <code class="language-plaintext highlighter-rouge">your.jupyterhub.com</code></li>
  <li>Client URI <a href="https://your.jupyterhub.com">https://your.jupyterhub.com</a></li>
  <li>Logo URI, anything, for example I used my Github avatar</li>
</ul>

<p>After having completed the process, you should see that your tenant is in the “Requested” state,
wait for the Custos admins to approve it.</p>

<h2 id="configure-jupyterhub">Configure JupyterHub</h2>

<p>Custom authenticators for JupyterHub need to be installed in the Docker image used to run the <code class="language-plaintext highlighter-rouge">hub</code> pod.
The Custos Authenticator for JupyterHub has <a href="https://pypi.org/project/custos-jupyterhub-authenticator/">a package on PyPI</a> so it is easy to add it to the JupyterHub image.
See <a href="https://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues/2265">this issue on zero-to-jupyterhub for more details</a></p>

<p>The Custos developers maintain Docker images which have this patch already applied, see the <a href="https://hub.docker.com/r/apachecustos/jupyter-hub-k8/tags">repository on DockerHub</a>.</p>

<p>We can therefore modify the JupyterHub configuration (<code class="language-plaintext highlighter-rouge">config_standard_storage.yaml</code> in my tutorials) and add:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hub:
  image:
    name: apachecustos/jupyter-hub-k8
    tag: 1.2.0
</code></pre></div></div>

<p>Consider that this will need to be updated if we change the version of the Helm recipe (currently 1.2.0).</p>

<h2 id="configure-the-custos-authenticator">Configure the Custos Authenticator</h2>

<p>Once the Custos tenant has been approved, we can proceed to configure JupyterHub with the right credentials,
again, modify <code class="language-plaintext highlighter-rouge">config_standard_storage.yaml</code> to add:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hub:
  extraConfig:
      00-custos: |
        from custosauthenticator.custos import CustosOAuthenticator
        c.JupyterHub.authenticator_class = CustosOAuthenticator
        c.CustosOAuthenticator.oauth_callback_url = "https://your.jupyterhub.com/hub/oauth_callback"
        c.CustosOAuthenticator.client_id = "custos-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        c.CustosOAuthenticator.client_secret = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        c.CustosOAuthenticator.login_service = "Custos Login"
        c.CustosOAuthenticator.custos_host= "custos.scigap.org"
</code></pre></div></div>

<p>Finally you can test in your browser, you probably need to test with an account different than the one you used to setup the tenant, so for example if you used XSEDE, now use CILogon with your institution or use ORCID.</p>

<p>With this default configuration, any user that can login to Custos can also login to JupyterHub, so if you already have permissions setup for your Custos gateway, those will be also applied to JupyterHub.</p>

<h2 id="work-in-progress">Work in progress</h2>

<ul>
  <li><a href="https://github.com/apache/airavata-custos/issues/265">Understand if we can login with owner account of tenant</a>.</li>
  <li><a href="https://github.com/apache/airavata-custos/issues/264">Fix the logout button</a></li>
</ul>

  </div><a class="u-url" href="/2022/04/jupyterhub-custos-authentication.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Tutorials and blog posts by Andrea Zonca: Python, Jupyter, Kubernetes</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/zonca" target="_blank" title="zonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/andreazonca" target="_blank" title="andreazonca"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
